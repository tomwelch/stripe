/**
 * Stripe Payments plugin for Craft CMS 3.x
 *
 * @link      https://enupal.com/
 * @copyright Copyright (c) 2018 Enupal LLC
 */
var enupalStripe={};!function(e){"use strict";enupalStripe={stripe:null,paymentFormsList:{},finalData:{},zeroDecimals:{},globalStyle:{},init:function(n){this.globalStyle={base:{color:"#32325d",lineHeight:"18px",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},n&&(this.globalStyle=n),this.paymentFormsList=e(".enupal-stripe-form-elements"),this.zeroDecimals=["MGA","BIF","CLP","PYG","DJF","RWF","GNF","UGX","JPY","VND","VUV","XAF","KMF","KRW","XOF","XPF"],this.paymentFormsList.each(function(){var n=e(this);enupalStripe.initializeForm(n)})},initializeForm:function(n){if(void 0===e(n).find('[name="enupalStripe[stripeData]"]').val())return!1;var a=e.parseJSON(e(n).find('[name="enupalStripe[stripeData]"]').val());navigator.userAgent.indexOf("Firefox")<0&&e(n).find('[name="enupalStripe[stripeData]"]').val(""),this.finalData.finalAmount=a.stripe.amount;var t=Stripe(a.pbk),i=t.elements({locale:a.stripe.locale}),r=e(n).find('[name="paymentType"]'),l=a.paymentTypeIds;if(l.length>1){var s=n.find(".cc-wrapper"),d=n.find(".ideal-wrapper"),o=n.find(".sofort-wrapper");e("#paymentMethod-"+a.paymentFormId).change(function(){var e=this.value;1==e?(r.val(e),s.removeClass("hidden"),d.addClass("hidden"),o.addClass("hidden")):2==e?(d.removeClass("hidden"),s.addClass("hidden"),o.addClass("hidden"),r.val(e)):3==e&&(o.removeClass("hidden"),d.addClass("hidden"),s.addClass("hidden"),r.val(e))})}if(a.enableShippingAddress&&a.enableBillingAddress){var m=n.find(".shippingAddressContainer");e("#enupalStripe-sameAddressToggle-"+a.paymentFormId).change(function(){this.checked?m.addClass("hidden"):m.removeClass("hidden")})}for(var p=0,u=l.length;p<u;p++)1==l[p]?(0==p&&(n.find(".cc-wrapper").removeClass("hidden"),r.val(l[p])),this.createCardElement(t,a,i,n)):2==l[p]?(0==p&&(n.find(".ideal-wrapper").removeClass("hidden"),r.val(l[p])),this.createIdealElement(t,a,n,i)):3==l[p]&&(0==p&&(n.find(".ideal-wrapper").removeClass("hidden"),n.find(".cc-wrapper").removeClass("hidden"),r.val(l[p])),this.createSofortElement(t,a,n,i))},createCardElement:function(n,a,t,i){var r="stripe-payments-submit-button-"+a.paymentFormId,l=t.create("card",{hidePostalCode:!0,style:this.globalStyle});l.mount("#card-element-"+a.paymentFormId),l.addEventListener("change",function(e){var n=document.getElementById("card-errors-"+a.paymentFormId);e.error?n.textContent=e.error.message:n.textContent=""});i[0];var s=this;i.find("#"+r).on("click",function(t){if(1!=e(i).find('[name="paymentType"]').val())return!0;var d=i[0];a.enableBillingAddress&&a.enableBillingAddress&&("on"==e(i).find('[name="enupalStripe[sameAddressToggle]"]').val()&&(e(i).find('[name="address[name]"]').removeAttr("required"),e(i).find('[name="address[line1]"]').removeAttr("required"),e(i).find('[name="address[city]"]').removeAttr("required"),e(i).find('[name="address[state]"]').removeAttr("required"),e(i).find('[name="address[zip]"]').removeAttr("required"),e(i).find('[name="address[country]"]').removeAttr("required")));if(d.checkValidity()){t.preventDefault();var o={};a.enableBillingAddress&&(o={name:e(i).find('[name="billingAddress[name]"]').val(),address_line1:e(i).find('[name="billingAddress[line1]"]').val(),address_city:e(i).find('[name="billingAddress[city]"]').val(),address_state:e(i).find('[name="billingAddress[state]"]').val(),address_zip:e(i).find('[name="billingAddress[zip]"]').val(),address_country:e(i).find('[name="billingAddress[country]"]').val()}),n.createToken(l,o).then(function(e){e.error?document.getElementById("card-errors-"+a.paymentFormId).textContent=e.error.message:s.submitForm(a,i,r,e.token)})}else d.reportValidity&&d.reportValidity()})},submitForm:function(n,a,t,i){var r=e.extend(!0,{},n),l=r.stripe;l.amount=this.convertToCents(this.getFinalAmount(a,r),l.currency),a.find('[name="enupalStripe[amount]"]').val(l.amount),a.find('[name="enupalStripe[testMode]"]').val(r.testMode),i&&a.find('[name="enupalStripe[token]"]').val(i.id),a.find("#"+t).prop("disabled",!0).find("span").text(n.paymentButtonProcessingText),a.unbind("submit",[a,n]),a.submit()},createIdealElement:function(n,a,t,i){var r=this,l=t[0],s="stripe-payments-submit-button-"+a.paymentFormId,d=i.create("idealBank",{style:this.globalStyle});d.mount("#ideal-bank-element-"+a.paymentFormId),d.on("change",function(e){var n=e.value;t.find('[name="idealBank"]').val(n)}),l.addEventListener("submit",function(n){if(2!=e(t).find('[name="paymentType"]').val())return!0;n.preventDefault(),r.submitForm(a,t,s,null)})},createSofortElement:function(n,a,t,i){var r=this,l=t[0],s="stripe-payments-submit-button-"+a.paymentFormId;l.addEventListener("submit",function(n){if(3!=e(t).find('[name="paymentType"]').val())return!0;n.preventDefault(),r.submitForm(a,t,s,null)})},getFinalAmount:function(n,a){var t=a.stripe.amount,i=0,r=!1;if(a.enableSubscriptions){var l=null;if(0==a.subscriptionType)a.singleSetupFee>0&&(i=a.singleSetupFee),a.enableCustomPlanAmount&&"undefined"!==(l=n.find('[name="enupalStripe[customPlanAmount]"]').val())&&l>0&&(t=l);else{var s=null;if(l=null,(s="radio"==a.subscriptionStyle?e('input[name="enupalStripe[enupalMultiPlan]"]:checked').val():n.find('[name="enupalStripe[enupalMultiPlan]"]').val())in a.multiplePlansAmounts&&(l=a.multiplePlansAmounts[s].amount,a.stripe.currency=a.multiplePlansAmounts[s].currency),s in a.setupFees){var d=a.setupFees[s];d>0&&(i=d)}"undefined"!==l&&l>0&&(t=l)}}else if(1==a.amountType){var o=n.find('[name="enupalStripe[customAmount]"]').val();r=n.find('[name="enupalStripe[recurringToggle]"]').is(":checked"),"undefined"!==o&&o>0&&(t=o)}if((a.applyTax||r)&&a.enableTaxes){var m=parseFloat(a.tax/100*(parseFloat(t)+parseFloat(i))).toFixed(2);t=parseFloat(t)+parseFloat(m);var p=a.taxLabel+": "+a.currencySymbol+m;n.find('[name="enupalStripe[taxAmount]"]').val(m),n.find('[name="tax-amount-label"]').empty().append(p)}return parseFloat(t)+parseFloat(i)},convertToCents:function(e,n){return this.hasZeroDecimals(n)?e:(100*e).toFixed(0)},convertFromCents:function(e,n){return this.hasZeroDecimals(n)?e:e/100},hasZeroDecimals:function(e){for(var n=0;n<this.zeroDecimals.length;n++)if(this.zeroDecimals[n]===e.toUpperCase())return!0;return!1}},e(document).ready(function(e){var n=null;"undefined"!=typeof enupalStyleOverrides&&(n=enupalStyleOverrides),enupalStripe.init(n)})}(jQuery);
